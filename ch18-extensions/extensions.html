<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>18. Extending QML with C++ &#8212; Qt5 Cadaques Book vmaster</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom-styles.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="19. Felgo Plugins and QML Hot Reloading" href="../ch19-felgo-plugins/felgo-plugins.html" />
    <link rel="prev" title="17. Qt and C++" href="../ch17-qtcpp/qtcpp.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          QmlBook</a>
        <span class="navbar-text navbar-version pull-left"><b>master</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Chapters <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ch01-meetqt/meetqt.html">1. Meet Qt 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch02-start/start.html">2. Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch03-qtcreator/qtcreator.html">3. Qt Creator IDE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch04-qmlstart/qmlstart.html">4. Quick Starter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch05-fluid/fluid.html">5. Fluid Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch06-controls/controls.html">6. Qt Quick Controls 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch07-modelview/modelview.html">7. Model-View-Delegate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch08-felgo/felgo.html">8. Felgo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch09-canvas/canvas.html">9. Canvas Element</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch10-particles/particles.html">10. Particle Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch11-shaders/shaders.html">11. Shader Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch12-multimedia/multimedia.html">12. Multimedia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch13-networking/networking.html">13. Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch14-storage/storage.html">14. Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch15-dynamicqml/dynamicqml.html">15. Dynamic QML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch16-javascript/javascript.html">16. JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch17-qtcpp/qtcpp.html">17. Qt and C++</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">18. Extending QML with C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch19-felgo-plugins/felgo-plugins.html">19. Felgo Plugins and QML Hot Reloading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch20-python/python.html">20. Qt for Python</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing/testing.html">1. Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/deployment.html">2. Deploying QML Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../draganddrop/draganddrop.html">3. Drag and Drop</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">18. Extending QML with C++</a><ul>
<li><a class="reference internal" href="#understanding-the-qml-run-time">18.1. Understanding the QML Run-time</a></li>
<li><a class="reference internal" href="#plugin-content">18.2. Plugin Content</a></li>
<li><a class="reference internal" href="#creating-the-plugin">18.3. Creating the plugin</a></li>
<li><a class="reference internal" href="#fileio-implementation">18.4. FileIO Implementation</a></li>
<li><a class="reference internal" href="#using-fileio">18.5. Using FileIO</a><ul>
<li><a class="reference internal" href="#the-application-window">18.5.1. The Application Window</a></li>
<li><a class="reference internal" href="#using-actions">18.5.2. Using Actions</a></li>
<li><a class="reference internal" href="#formatting-the-table">18.5.3. Formatting the Table</a></li>
<li><a class="reference internal" href="#reading-data">18.5.4. Reading Data</a></li>
<li><a class="reference internal" href="#writing-data">18.5.5. Writing Data</a></li>
<li><a class="reference internal" href="#finishing-touch">18.5.6. Finishing Touch</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">18.6. Summary</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../ch17-qtcpp/qtcpp.html" title="Previous Chapter: 17. Qt and C++"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 17. Qt and C++</span>
    </a>
  </li>
  <li>
    <a href="../ch19-felgo-plugins/felgo-plugins.html" title="Next Chapter: 19. Felgo Plugins and QML Hot Reloading"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">19. Felgo Plu... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">18. Extending QML with C++</a><ul>
<li><a class="reference internal" href="#understanding-the-qml-run-time">18.1. Understanding the QML Run-time</a></li>
<li><a class="reference internal" href="#plugin-content">18.2. Plugin Content</a></li>
<li><a class="reference internal" href="#creating-the-plugin">18.3. Creating the plugin</a></li>
<li><a class="reference internal" href="#fileio-implementation">18.4. FileIO Implementation</a></li>
<li><a class="reference internal" href="#using-fileio">18.5. Using FileIO</a><ul>
<li><a class="reference internal" href="#the-application-window">18.5.1. The Application Window</a></li>
<li><a class="reference internal" href="#using-actions">18.5.2. Using Actions</a></li>
<li><a class="reference internal" href="#formatting-the-table">18.5.3. Formatting the Table</a></li>
<li><a class="reference internal" href="#reading-data">18.5.4. Reading Data</a></li>
<li><a class="reference internal" href="#writing-data">18.5.5. Writing Data</a></li>
<li><a class="reference internal" href="#finishing-touch">18.5.6. Finishing Touch</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">18.6. Summary</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <div class="section" id="extending-qml-with-c">
<h1>18. Extending QML with C++<a class="headerlink" href="#extending-qml-with-c" title="Permalink to this headline">Â¶</a></h1>
<p><em>Section author: <a class="reference external" href="https://www.linkedin.com/in/jryannel">jryannel&#64;LinkedIn</a></em></p>
<p><div class="btn-group btn-group-justified" role="group"><a class="btn btn-primary btn-xs" href="https://github.com/qmlbook/qmlbook/" target="_blank">Github</a><a class="btn btn-primary btn-xs" href="https://github.com/qmlbook/qmlbook//blob/master/docs/ch18-extensions/extensions.rst" target="_blank"><i class="glyphicon glyphicon-file"></i> View</a><a class="btn btn-primary btn-xs" href="https://github.com/qmlbook/qmlbook//edit/master/docs/ch18-extensions/extensions.rst" target="_blank"><i class="glyphicon glyphicon-pencil"></i> Edit</a><a class="btn btn-primary btn-xs" href="https://github.com/qmlbook/qmlbook//issues/new?labels=ch18&body=back-link%3A+ch18-extensions%2Fextensions.html%23extending-qml-with-c" target="_blank"><i class="glyphicon glyphicon-plus"></i> Issue </a><a  class="btn btn-primary btn-xs" href="https://github.com/qmlbook/qmlbook//issues?labels=ch18&page=1&state=open" target="_blank"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Last Build: November 10, 2020 at 08:11 CET</p>
<p class="last">The source code for this chapter can be found in the <a class="reference external" href="../assets">assets folder</a>.</p>
</div>
<p>Executing QML within the confined space that QML as a language offers can sometimes be limiting. By extending the QML run-time with native functionality written in C++, the application can utilize the full performance and freedom of the base platform.</p>
<div class="section" id="understanding-the-qml-run-time">
<h2>18.1. Understanding the QML Run-time<a class="headerlink" href="#understanding-the-qml-run-time" title="Permalink to this headline">Â¶</a></h2>
<p><div class="btn-group" role="group"><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook//new?labels=ch16&body=back-link%3A+ch18-extensions%2Fextensions.html%23understanding-the-qml-run-time"><i class="glyphicon glyphicon-plus"></i> Issue</a><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook/?labels=ch16&page=1&state=open"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><p>When running QML, it is being executed in a run-time environment. The run-time is implemented in C++ in the <code class="docutils literal notranslate"><span class="pre">QtQml</span></code> module. It consists of an engine, responsible for the execution of QML, contexts, holding the properties accessible for each component, and components, the instantiated QML elements.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;QtGui&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;QtQml&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">QGuiApplication</span> <span class="n">app</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="n">QUrl</span> <span class="n">source</span><span class="p">(</span><span class="n">QStringLiteral</span><span class="p">(</span><span class="s">&quot;qrc:/main.qml&quot;</span><span class="p">));</span>
    <span class="n">QQmlApplicationEngine</span> <span class="n">engine</span><span class="p">;</span>
    <span class="n">engine</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">app</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the example, the <code class="docutils literal notranslate"><span class="pre">QGuiApplication</span></code> encapsulates all that is related to the application instance (e.g. application name, command line arguments and managing the event loop). The <code class="docutils literal notranslate"><span class="pre">QQmlApplicationEngine</span></code> manages the hierarchical order of contexts and components. It requires typical a QML file to be loaded as the starting point of your application. In this case, it is a <code class="docutils literal notranslate"><span class="pre">main.qml</span></code> containing a window and a text type.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Loading a <code class="docutils literal notranslate"><span class="pre">main.qml</span></code> with a simple <code class="docutils literal notranslate"><span class="pre">Item</span></code> as the root type through the <code class="docutils literal notranslate"><span class="pre">QmlApplicationEngine</span></code> will not show anything on your display, as it requires a window to manage a surface for rendering. The engine is capable of loading QML code which does not contain any user interface (e.g plain objects). Because of this, it does not create a window for you by default. The <code class="docutils literal notranslate"><span class="pre">qmlscene</span></code> or the new <code class="docutils literal notranslate"><span class="pre">qml</span></code> runtime will internally first check if the main QML file contains a window as a root item and if not create one for you and set the root item as a child to the newly created window.</p>
</div>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>
<span class="kr">import</span> <span class="nx">QtQuick</span><span class="p">.</span><span class="nx">Window</span> <span class="mf">2.2</span>

<span class="nx">Window</span> <span class="p">{</span>
    <span class="k">visible:</span> <span class="kc">true</span>
    <span class="k">width:</span> <span class="mi">512</span>
    <span class="k">height:</span> <span class="mi">300</span>

    <span class="nx">Text</span> <span class="p">{</span>
        <span class="k">anchors.centerIn:</span> <span class="nx">parent</span>
        <span class="k">text:</span> <span class="s2">&quot;Hello World!&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the QML file we declare our dependencies here it is <code class="docutils literal notranslate"><span class="pre">QtQuick</span></code> and <code class="docutils literal notranslate"><span class="pre">QtQuick.Window</span></code>. This declaration will trigger a lookup for these modules in the import paths and on success will load the required plugins by the engine. The newly loaded types will then be made available to the QML file controlled by a <code class="docutils literal notranslate"><span class="pre">qmldir</span></code>.</p>
<p>It is also possible to shortcut the plugin creation by adding our types directly to the engine. Here we assume we have a <code class="docutils literal notranslate"><span class="pre">CurrentTime</span></code> <code class="docutils literal notranslate"><span class="pre">QObject</span></code> based class.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">QQmlApplicationEngine</span> <span class="n">engine</span><span class="p">;</span>

<span class="n">qmlRegisterType</span><span class="o">&lt;</span><span class="n">CurrentTime</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;org.example&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;CurrentTime&quot;</span><span class="p">);</span>

<span class="n">engine</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
</pre></div>
</div>
<p>Now we can also use the <code class="docutils literal notranslate"><span class="pre">CurrentTime</span></code> type in our QML file.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">org</span><span class="p">.</span><span class="nx">example</span> <span class="mf">1.0</span>

<span class="nx">CurrentTime</span> <span class="p">{</span>
    <span class="c1">// access properties, functions, signals</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For the really lazy there is also the very direct way through context properties.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="nx">QScopedPointer</span><span class="o">&lt;</span><span class="nx">CurrentTime</span><span class="o">&gt;</span> <span class="nx">current</span><span class="p">(</span><span class="k">new</span> <span class="nx">CurrentTime</span><span class="p">());</span>

<span class="nx">QQmlApplicationEngine</span> <span class="nx">engine</span><span class="p">;</span>

<span class="nx">engine</span><span class="p">.</span><span class="nx">rootContext</span><span class="p">().</span><span class="nx">setContextProperty</span><span class="p">(</span><span class="s2">&quot;current&quot;</span><span class="p">,</span> <span class="nx">current</span><span class="p">.</span><span class="nx">value</span><span class="p">())</span>

<span class="nx">engine</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Do not mix up <code class="docutils literal notranslate"><span class="pre">setContextProperty()</span></code> and <code class="docutils literal notranslate"><span class="pre">setProperty()</span></code>. The first one sets a context property on a qml context, and <code class="docutils literal notranslate"><span class="pre">setProperty()</span></code> sets a dynamic property value on a <code class="docutils literal notranslate"><span class="pre">QObject</span></code> and will not help you.</p>
</div>
<p>Now you can use the current property everywhere in your application. Thanks to context inheritance.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>
<span class="kr">import</span> <span class="nx">QtQuick</span><span class="p">.</span><span class="nx">Window</span> <span class="mf">2.0</span>

<span class="nx">Window</span> <span class="p">{</span>
    <span class="k">visible:</span> <span class="kc">true</span>
    <span class="k">width:</span> <span class="mi">512</span>
    <span class="k">height:</span> <span class="mi">300</span>

    <span class="k">Component.onCompleted:</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;current: &#39;</span> <span class="o">+</span> <span class="nx">current</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here are the different ways you can extend QML in general:</p>
<ul class="simple">
<li>Context properties - <code class="docutils literal notranslate"><span class="pre">setContextProperty()</span></code></li>
<li>Register type with engine - calling <code class="docutils literal notranslate"><span class="pre">qmlRegisterType</span></code> in your main.cpp</li>
<li>QML extension plugins - To be discussed next</li>
</ul>
<p><strong>Context properties</strong> are easy to use for small applications. They do not require any effort you just expose your system API with kind of global objects. It is helpful to ensure there will be no naming conflicts (e.g by using a special character for this (<code class="docutils literal notranslate"><span class="pre">$</span></code>) for example <code class="docutils literal notranslate"><span class="pre">$.currentTime</span></code>). <code class="docutils literal notranslate"><span class="pre">$</span></code> is a valid character for JS variables.</p>
<p><strong>Registering QML types</strong> allows the user to control the lifecycle of a c++ object from QML. This is not possible with the context properties. Also, it does not pollute the global namespace. Still all types need to be registered first and by this, all libraries need to be linked on application start, which in most cases is not really a problem.</p>
<p>The most flexible system is provided by the <strong>QML extension plugins</strong>. They allow you to register types in a plugin which is loaded when the first QML file calls the import identifier. Also by using a QML singleton, there is no need to pollute the global namespace anymore. Plugins allow you to reuse modules across projects, which comes quite handy when you do more than one project with Qt.</p>
<p>For the remainder of this chapter will focus on the QML extension plugins. As they provide the greatest flexibility and reuse.</p>
</div>
<div class="section" id="plugin-content">
<h2>18.2. Plugin Content<a class="headerlink" href="#plugin-content" title="Permalink to this headline">Â¶</a></h2>
<p>A plugin is a library with a defined interface, which is loaded on demand. This differs from a library as a library is linked and loaded on startup of the application. In the QML case, the interface is called <code class="docutils literal notranslate"><span class="pre">QQmlExtensionPlugin</span></code>. There are two methods interesting for us <code class="docutils literal notranslate"><span class="pre">initializeEngine()</span></code> and <code class="docutils literal notranslate"><span class="pre">registerTypes()</span></code>. When the plugin is loaded first the <code class="docutils literal notranslate"><span class="pre">initializeEngine()</span></code> is called, which allows us to access the engine to expose plugin objects to the root context. In the majority, you will only use the <code class="docutils literal notranslate"><span class="pre">registerTypes()</span></code> method. This allows you to register your custom QML types with the engine on the provided URL.</p>
<p>Let us step back a little bit and think about a potential file IO type which would allow us to read/write small text files from QML. A first iteration could look like this in a mocked QML implementation.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="c1">// FileIO.qml (good)</span>
<span class="nx">QtObject</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">write</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{};</span>
    <span class="kd">function</span> <span class="nx">read</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is a pure QML implementation of a possible C++ based QML API for exploring an API. We see we should have a read and write function. Where the write function takes a path and a text and the read function takes a path and returns a text. As it looks path and text are common parameters and maybe we can extract them as properties.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="c1">// FileIO.qml (better)</span>
<span class="nx">QtObject</span> <span class="p">{</span>
    <span class="nx">property</span> <span class="nx">url</span> <span class="nx">source</span>
    <span class="nx">property</span> <span class="nx">string</span> <span class="nx">text</span>
    <span class="kd">function</span> <span class="nx">write</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// open file and write text };</span>
    <span class="kd">function</span> <span class="nx">read</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// read file and assign to text };</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Yes, this looks more like a QML API. We use properties to allow our environment to bind to our properties and react to changes.</p>
<p>To create this API in C++ we would need to create an interface something like this.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FileIO</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QObject</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">Q_PROPERTY</span><span class="p">(</span><span class="n">QUrl</span> <span class="n">source</span> <span class="n">READ</span> <span class="n">source</span> <span class="n">WRITE</span> <span class="n">setSource</span> <span class="n">NOTIFY</span> <span class="n">sourceChanged</span><span class="p">)</span>
    <span class="n">Q_PROPERTY</span><span class="p">(</span><span class="n">QString</span> <span class="n">text</span> <span class="n">READ</span> <span class="n">text</span> <span class="n">WRITE</span> <span class="n">setText</span> <span class="n">NOTIFY</span> <span class="n">textChanged</span><span class="p">)</span>
    <span class="p">...</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">Q_INVOKABLE</span> <span class="kt">void</span> <span class="n">read</span><span class="p">();</span>
    <span class="n">Q_INVOKABLE</span> <span class="kt">void</span> <span class="n">write</span><span class="p">();</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">FileIO</span></code> type need to be registered with the QML engine. We want to use it under the âorg.example.ioâ module</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">org</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">io</span> <span class="mf">1.0</span>

<span class="nx">FileIO</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A plugin could expose several types with the same module. But it can not expose several modules from one plugin. So there is a one to one relationship between modules and plugins. This relationship is expressed by the module identifier.</p>
</div>
<div class="section" id="creating-the-plugin">
<h2>18.3. Creating the plugin<a class="headerlink" href="#creating-the-plugin" title="Permalink to this headline">Â¶</a></h2>
<p>Qt Creator contains a wizard to create a <strong>QtQuick 2 QML Extension Plugin</strong> we use it to create a plugin called <code class="docutils literal notranslate"><span class="pre">fileio</span></code> with a <code class="docutils literal notranslate"><span class="pre">FileIO</span></code> object to start within the module <strong>âorg.example.ioâ</strong>.</p>
<p>The plugin class is derived from <code class="docutils literal notranslate"><span class="pre">QQmlExtensionPlugin</span></code> and implements the <code class="docutils literal notranslate"><span class="pre">registerTypes()</span></code> function. The <code class="docutils literal notranslate"><span class="pre">Q_PLUGIN_METADATA</span></code>  line is mandatory to identify the plugin as a QML extension plugin. Besides this, there is nothing spectacular going on.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef FILEIO_PLUGIN_H</span>
<span class="cp">#define FILEIO_PLUGIN_H</span>

<span class="cp">#include</span> <span class="cpf">&lt;QQmlExtensionPlugin&gt;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">FileioPlugin</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QQmlExtensionPlugin</span>
<span class="p">{</span>
    <span class="n">Q_OBJECT</span>
    <span class="nf">Q_PLUGIN_METADATA</span><span class="p">(</span><span class="n">IID</span> <span class="s">&quot;org.qt-project.Qt.QQmlExtensionInterface&quot;</span><span class="p">)</span>

<span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">registerTypes</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="c1">// FILEIO_PLUGIN_H</span>
</pre></div>
</div>
<p>In the implementation of the <code class="docutils literal notranslate"><span class="pre">registerTypes</span></code> we simply register our <code class="docutils literal notranslate"><span class="pre">FileIO</span></code> class using the <code class="docutils literal notranslate"><span class="pre">qmlRegisterType</span></code> function.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;fileio_plugin.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;fileio.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;qqml.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="n">FileioPlugin</span><span class="o">::</span><span class="n">registerTypes</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// @uri org.example.io</span>
    <span class="n">qmlRegisterType</span><span class="o">&lt;</span><span class="n">FileIO</span><span class="o">&gt;</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;FileIO&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Interestingly we cannot see here the module URI (e.g. <strong>org.example.io</strong>). This seems to be set from the outside.</p>
<p>When you look into your project directory you will find a <code class="docutils literal notranslate"><span class="pre">qmldir</span></code> file. This file specifies the content of your QML plugin or better the QML side of your plugin. It should look like this for you.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="nx">module</span> <span class="nx">org</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">io</span>
<span class="nx">plugin</span> <span class="nx">fileio</span>
</pre></div>
</div>
<p>The module is the URI under which your plugin is reachable by others and the plugin line must be identical with your plugin file name (under mac this would be <em>libfileio_debug.dylib</em> on the file system and <em>fileio</em> in the <em>qmldir</em>). These files are created by Qt Creator based on the given information. The module URI is also available in the .pro file. There is used to build up the install directory.</p>
<p>When you call <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> in your build folder the library will be copied into the Qt <code class="docutils literal notranslate"><span class="pre">qml</span></code> folder (for Qt 5.4 on mac this would be <em>â~/Qt/5.4/clang_64/qmlâ</em>. The exact path depends on your Qt installation location and the used compiler on your system). There you will find a library inside the âorg/example/ioâ folder. The content are these two files currently</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">libfileio_debug.dylib</span>
<span class="na">qmldir</span>
</pre></div>
</div>
<p>When importing a module called âorg.example.ioâ, the QML engine will look in one of the import paths and tries to locate the âorg/example/ioâ path with a qmldir. The qmldir then will tell the engine which library to load as a QML extension plugin using which module URI. Two modules with the same URI will override each other.</p>
</div>
<div class="section" id="fileio-implementation">
<h2>18.4. FileIO Implementation<a class="headerlink" href="#fileio-implementation" title="Permalink to this headline">Â¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">FileIO</span></code> implementation is straightforward. Remember the API we want to create should look like this.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FileIO</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QObject</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">Q_PROPERTY</span><span class="p">(</span><span class="n">QUrl</span> <span class="n">source</span> <span class="n">READ</span> <span class="n">source</span> <span class="n">WRITE</span> <span class="n">setSource</span> <span class="n">NOTIFY</span> <span class="n">sourceChanged</span><span class="p">)</span>
    <span class="n">Q_PROPERTY</span><span class="p">(</span><span class="n">QString</span> <span class="n">text</span> <span class="n">READ</span> <span class="n">text</span> <span class="n">WRITE</span> <span class="n">setText</span> <span class="n">NOTIFY</span> <span class="n">textChanged</span><span class="p">)</span>
    <span class="p">...</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">Q_INVOKABLE</span> <span class="kt">void</span> <span class="n">read</span><span class="p">();</span>
    <span class="n">Q_INVOKABLE</span> <span class="kt">void</span> <span class="n">write</span><span class="p">();</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We will leave out the properties, as they are simple setters and getters.</p>
<p>The read method opens a file in reading mode and reads the data using a text stream.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">FileIO</span><span class="o">::</span><span class="n">read</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">m_source</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">QFile</span> <span class="n">file</span><span class="p">(</span><span class="n">m_source</span><span class="p">.</span><span class="n">toLocalFile</span><span class="p">());</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">exists</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">qWarning</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Does not exits: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_source</span><span class="p">.</span><span class="n">toLocalFile</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">QIODevice</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">QTextStream</span> <span class="nf">stream</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="p">);</span>
        <span class="n">m_text</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="n">readAll</span><span class="p">();</span>
        <span class="n">emit</span> <span class="nf">textChanged</span><span class="p">(</span><span class="n">m_text</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When the text is changed it is necessary to inform others about the change using <code class="docutils literal notranslate"><span class="pre">emit</span> <span class="pre">textChanged(m_text)</span></code>. Otherwise, property binding will not work.</p>
<p>The write method does the same but opens the file in write mode and uses the stream to write the contents.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">FileIO</span><span class="o">::</span><span class="n">write</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">m_source</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">QFile</span> <span class="n">file</span><span class="p">(</span><span class="n">m_source</span><span class="p">.</span><span class="n">toLocalFile</span><span class="p">());</span>
    <span class="k">if</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">QIODevice</span><span class="o">::</span><span class="n">WriteOnly</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">QTextStream</span> <span class="nf">stream</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="p">);</span>
        <span class="n">stream</span> <span class="o">&lt;&lt;</span> <span class="n">m_text</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Do not forget to call <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> at the end. Otherwise, your plugin files will not be copied over to the qml folder and the qml engine will not be able to locate the module.</p>
<p>As the reading and writing are blocking you should only use this <code class="docutils literal notranslate"><span class="pre">FileIO</span></code> for small texts, otherwise, you will block the UI thread of Qt. Be warned!</p>
</div>
<div class="section" id="using-fileio">
<h2>18.5. Using FileIO<a class="headerlink" href="#using-fileio" title="Permalink to this headline">Â¶</a></h2>
<p>Now we can use our newly created file to access some nice data. For this example, we want to read some city data in a JSON format and display it in a table. We will use two projects, one the extension plugin (called <code class="docutils literal notranslate"><span class="pre">fileio</span></code>) which provides us a way to read and write text from a file and the other one, which displays the data in a table (<code class="docutils literal notranslate"><span class="pre">CityUI</span></code>) by using the file io for reading and writing of files. The data used in this example is in the <code class="docutils literal notranslate"><span class="pre">cities.json</span></code> file.</p>
<div class="figure">
<img alt="../_images/cityui_mock.png" src="../_images/cityui_mock.png" />
</div>
<p>JSON is just text, which is formatted in such a way that it can be converted into a valid JS object/array and back to the text. We use our <code class="docutils literal notranslate"><span class="pre">FileIO</span></code> to read the JSON formatted data and convert it into a JS object using <code class="docutils literal notranslate"><span class="pre">JSON.parse()</span></code>. The data is later used as a model for the table view. This is roughly the content of our read document function. For saving, we convert the data back into a text format and use the write function for saving.</p>
<p>The city JSON data is a formatted text file, with a set of city data entries, where each entry contains interesting data about the city.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;area&quot;</span><span class="o">:</span> <span class="s2">&quot;1928&quot;</span><span class="p">,</span>
        <span class="s2">&quot;city&quot;</span><span class="o">:</span> <span class="s2">&quot;Shanghai&quot;</span><span class="p">,</span>
        <span class="s2">&quot;country&quot;</span><span class="o">:</span> <span class="s2">&quot;China&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flag&quot;</span><span class="o">:</span> <span class="s2">&quot;22px-Flag_of_the_People&#39;s_Republic_of_China.svg.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;population&quot;</span><span class="o">:</span> <span class="s2">&quot;13831900&quot;</span>
    <span class="p">},</span>
    <span class="p">...</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="section" id="the-application-window">
<h3>18.5.1. The Application Window<a class="headerlink" href="#the-application-window" title="Permalink to this headline">Â¶</a></h3>
<p>We use the Qt Creator <code class="docutils literal notranslate"><span class="pre">QtQuick</span> <span class="pre">Application</span></code> wizard to create a Qt Quick controls based application. We will not use the new QML forms as this is difficult to explain in a book, although the new forms approach with a <em>ui.qml</em> file is much more usable than previous. So you can remove/delete the forms file for now.</p>
<p>The basic setup is an <code class="docutils literal notranslate"><span class="pre">ApplicationWindow</span></code> which can contain a toolbar, menubar, and status bar. We will only use the menubar to create some standard menu entries for opening and saving the document. The basic setup will just display an empty window.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>
<span class="kr">import</span> <span class="nx">QtQuick</span><span class="p">.</span><span class="nx">Controls</span> <span class="mf">1.3</span>
<span class="kr">import</span> <span class="nx">QtQuick</span><span class="p">.</span><span class="nx">Window</span> <span class="mf">2.2</span>
<span class="kr">import</span> <span class="nx">QtQuick</span><span class="p">.</span><span class="nx">Dialogs</span> <span class="mf">1.2</span>

<span class="nx">ApplicationWindow</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="k">title:</span> <span class="nx">qsTr</span><span class="p">(</span><span class="s2">&quot;City UI&quot;</span><span class="p">)</span>
    <span class="k">width:</span> <span class="mi">640</span>
    <span class="k">height:</span> <span class="mi">480</span>
    <span class="k">visible:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="using-actions">
<h3>18.5.2. Using Actions<a class="headerlink" href="#using-actions" title="Permalink to this headline">Â¶</a></h3>
<p>To better use/reuse our commands we use the QML <code class="docutils literal notranslate"><span class="pre">Action</span></code> type. This will allow us later to use the same action also for a potential toolbar. The open and save and exit actions are quite standard. The open and save action do not contain any logic yet, this we will come later. The menubar is created with a file menu and these three action entries. Additional we prepare already a file dialog, which will allow us to pick our city document later. A dialog is not visible when declared, you need to use the <code class="docutils literal notranslate"><span class="pre">open()</span></code> method to show it.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="nx">Action</span> <span class="p">{</span>
    <span class="kd">id: save</span>
    <span class="k">text:</span> <span class="nx">qsTr</span><span class="p">(</span><span class="s2">&quot;&amp;Save&quot;</span><span class="p">)</span>
    <span class="k">shortcut:</span> <span class="nx">StandardKey</span><span class="p">.</span><span class="nx">Save</span>
    <span class="k">onTriggered:</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Action</span> <span class="p">{</span>
    <span class="kd">id: open</span>
    <span class="k">text:</span> <span class="nx">qsTr</span><span class="p">(</span><span class="s2">&quot;&amp;Open&quot;</span><span class="p">)</span>
    <span class="k">shortcut:</span> <span class="nx">StandardKey</span><span class="p">.</span><span class="nx">Open</span>
    <span class="k">onTriggered:</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="nx">Action</span> <span class="p">{</span>
    <span class="kd">id: exit</span>
    <span class="k">text:</span> <span class="nx">qsTr</span><span class="p">(</span><span class="s2">&quot;E&amp;xit&quot;</span><span class="p">)</span>
    <span class="k">onTriggered:</span> <span class="nx">Qt</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">menuBar:</span> <span class="nx">MenuBar</span> <span class="p">{</span>
    <span class="nx">Menu</span> <span class="p">{</span>
        <span class="k">title:</span> <span class="nx">qsTr</span><span class="p">(</span><span class="s2">&quot;&amp;File&quot;</span><span class="p">)</span>
        <span class="nx">MenuItem</span> <span class="p">{</span> <span class="k">action:</span> <span class="nx">open</span> <span class="p">}</span>
        <span class="nx">MenuItem</span> <span class="p">{</span> <span class="k">action:</span> <span class="nx">save</span> <span class="p">}</span>
        <span class="nx">MenuSeparator</span> <span class="p">{</span> <span class="p">}</span>
        <span class="nx">MenuItem</span> <span class="p">{</span> <span class="k">action:</span> <span class="nx">exit</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="nx">FileDialog</span> <span class="p">{</span>
    <span class="kd">id: openDialog</span>
    <span class="k">onAccepted:</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="formatting-the-table">
<h3>18.5.3. Formatting the Table<a class="headerlink" href="#formatting-the-table" title="Permalink to this headline">Â¶</a></h3>
<p>The content of the city data shall be displayed in a table. For this, we use the <code class="docutils literal notranslate"><span class="pre">TableView</span></code> control and declare 4 columns: city, country, area, population. Each column is a standard <code class="docutils literal notranslate"><span class="pre">TableViewColumn</span></code>. Later we will add columns for the flag and remove operation which will require a custom column delegate.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="nx">TableView</span> <span class="p">{</span>
    <span class="kd">id: view</span>
    <span class="k">anchors.fill:</span> <span class="nx">parent</span>
    <span class="nx">TableViewColumn</span> <span class="p">{</span>
        <span class="k">role:</span> <span class="s1">&#39;city&#39;</span>
        <span class="k">title:</span> <span class="s2">&quot;City&quot;</span>
        <span class="k">width:</span> <span class="mi">120</span>
    <span class="p">}</span>
    <span class="nx">TableViewColumn</span> <span class="p">{</span>
        <span class="k">role:</span> <span class="s1">&#39;country&#39;</span>
        <span class="k">title:</span> <span class="s2">&quot;Country&quot;</span>
        <span class="k">width:</span> <span class="mi">120</span>
    <span class="p">}</span>
    <span class="nx">TableViewColumn</span> <span class="p">{</span>
        <span class="k">role:</span> <span class="s1">&#39;area&#39;</span>
        <span class="k">title:</span> <span class="s2">&quot;Area&quot;</span>
        <span class="k">width:</span> <span class="mi">80</span>
    <span class="p">}</span>
    <span class="nx">TableViewColumn</span> <span class="p">{</span>
        <span class="k">role:</span> <span class="s1">&#39;population&#39;</span>
        <span class="k">title:</span> <span class="s2">&quot;Population&quot;</span>
        <span class="k">width:</span> <span class="mi">80</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now the application should show you a menubar with a file menu and an empty table with 4 table headers. The next step will be to populate the table with useful data using our <em>FileIO</em> extension.</p>
<div class="figure">
<img alt="../_images/cityui_empty.png" src="../_images/cityui_empty.png" />
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cities.json</span></code> document is an array of city entries. Here is an example.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;area&quot;</span><span class="o">:</span> <span class="s2">&quot;1928&quot;</span><span class="p">,</span>
        <span class="s2">&quot;city&quot;</span><span class="o">:</span> <span class="s2">&quot;Shanghai&quot;</span><span class="p">,</span>
        <span class="s2">&quot;country&quot;</span><span class="o">:</span> <span class="s2">&quot;China&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flag&quot;</span><span class="o">:</span> <span class="s2">&quot;22px-Flag_of_the_People&#39;s_Republic_of_China.svg.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;population&quot;</span><span class="o">:</span> <span class="s2">&quot;13831900&quot;</span>
    <span class="p">},</span>
    <span class="p">...</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Our job is it to allow the user to select the file, read it, convert it and set it onto the table view.</p>
</div>
<div class="section" id="reading-data">
<h3>18.5.4. Reading Data<a class="headerlink" href="#reading-data" title="Permalink to this headline">Â¶</a></h3>
<p>For this we let the open action open the file dialog. When the user has selected a file the <code class="docutils literal notranslate"><span class="pre">onAccepted</span></code> method is called on the file dialog. There we call the <code class="docutils literal notranslate"><span class="pre">readDocument()</span></code> function. The <code class="docutils literal notranslate"><span class="pre">readDocument()</span></code> function sets the URL from the file dialog to our <code class="docutils literal notranslate"><span class="pre">FileIO</span></code> object and calls the <code class="docutils literal notranslate"><span class="pre">read()</span></code> method. The loaded text from <code class="docutils literal notranslate"><span class="pre">FileIO</span></code> is then parsed using the <code class="docutils literal notranslate"><span class="pre">JSON.parse()</span></code> method and the resulting object is directly set onto the table view as a model. How convenient is that?</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="nx">Action</span> <span class="p">{</span>
    <span class="kd">id: open</span>
    <span class="p">...</span>
    <span class="k">onTriggered:</span> <span class="p">{</span>
        <span class="nx">openDialog</span><span class="p">.</span><span class="nx">open</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="nx">FileDialog</span> <span class="p">{</span>
    <span class="kd">id: openDialog</span>
    <span class="k">onAccepted:</span> <span class="p">{</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">readDocument</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">readDocument</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">io</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">openDialog</span><span class="p">.</span><span class="nx">fileUrl</span>
    <span class="nx">io</span><span class="p">.</span><span class="nx">read</span><span class="p">()</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span>
<span class="p">}</span>


<span class="nx">FileIO</span> <span class="p">{</span>
    <span class="kd">id: io</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-data">
<h3>18.5.5. Writing Data<a class="headerlink" href="#writing-data" title="Permalink to this headline">Â¶</a></h3>
<p>For saving the document, we hook up the âsaveâ action to the <code class="docutils literal notranslate"><span class="pre">saveDocument()</span></code> function. The save document function takes the model from the view, which is a JS object and converts it into a string using the <code class="docutils literal notranslate"><span class="pre">JSON.stringify()</span></code> function. The resulting string is set to the text property of our <code class="docutils literal notranslate"><span class="pre">FileIO</span></code> object and we call <code class="docutils literal notranslate"><span class="pre">write()</span></code> to save the data to disk. The ânullâ and â4â parameters on the <code class="docutils literal notranslate"><span class="pre">stringify</span></code> function will format the resulting JSON data using indentation with 4 spaces. This is just for better reading of the saved document.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="nx">Action</span> <span class="p">{</span>
    <span class="kd">id: save</span>
    <span class="p">...</span>
    <span class="k">onTriggered:</span> <span class="p">{</span>
        <span class="nx">saveDocument</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">saveDocument</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">model</span>
    <span class="nx">io</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nx">io</span><span class="p">.</span><span class="nx">write</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">FileIO</span> <span class="p">{</span>
    <span class="kd">id: io</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is basically the application with reading, writing and displaying a JSON document. Think about all the time spend by writing XML readers and writers. With JSON all you need is a way to read and write a text file or send receive a text buffer.</p>
<div class="figure">
<img alt="../_images/cityui_table.png" src="../_images/cityui_table.png" />
</div>
</div>
<div class="section" id="finishing-touch">
<h3>18.5.6. Finishing Touch<a class="headerlink" href="#finishing-touch" title="Permalink to this headline">Â¶</a></h3>
<p>The application is not fully ready yet. We still want to show the flags and allow the user to modify the document by removing cities from the model.</p>
<p>The flags are stored for this example relative to the <code class="docutils literal notranslate"><span class="pre">main.qml</span></code> document in a <em>flags</em> folder. To be able to show them the table column needs to define a custom delegate for rendering the flag image.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="nx">TableViewColumn</span> <span class="p">{</span>
    <span class="k">delegate:</span> <span class="nx">Item</span> <span class="p">{</span>
        <span class="nx">Image</span> <span class="p">{</span>
            <span class="k">anchors.centerIn:</span> <span class="nx">parent</span>
            <span class="k">source:</span> <span class="s1">&#39;flags/&#39;</span> <span class="o">+</span> <span class="nx">styleData</span><span class="p">.</span><span class="nx">value</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">role:</span> <span class="s1">&#39;flag&#39;</span>
    <span class="k">title:</span> <span class="s2">&quot;Flag&quot;</span>
    <span class="k">width:</span> <span class="mi">40</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That is all. It exposes the flag property from the JS model as <code class="docutils literal notranslate"><span class="pre">styleData.value</span></code> to the delegate. The delegate then adjusts the image path to pre-pend <code class="docutils literal notranslate"><span class="pre">'flags/'</span></code> and displays it.</p>
<p>For removing we use a similar technique to display a remove button.</p>
<div class="highlight-qml notranslate"><div class="highlight"><pre><span></span><span class="nx">TableViewColumn</span> <span class="p">{</span>
    <span class="k">delegate:</span> <span class="nx">Button</span> <span class="p">{</span>
        <span class="k">iconSource:</span> <span class="s2">&quot;remove.png&quot;</span>
        <span class="k">onClicked:</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">model</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">styleData</span><span class="p">.</span><span class="nx">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="nx">view</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">data</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">width:</span> <span class="mi">40</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For the data removal operation, we get a hold on the view model and then remove one entry using the JS <code class="docutils literal notranslate"><span class="pre">splice</span></code> function. This method is available to us as the model is from the type JS array. The splice method changes the content of an array by removing existing elements and/or adding new elements.</p>
<p>A JS array is unfortunately not so smart as a Qt model like the <code class="docutils literal notranslate"><span class="pre">QAbstractItemModel</span></code>, which will notify the view about row changes or data changes. The view will not show any updated data by now as it is never notified of any changes. Only when we set the data back to the view, the view recognizes there is new data and refreshes the view content. Setting the model again using <code class="docutils literal notranslate"><span class="pre">view.model</span> <span class="pre">=</span> <span class="pre">data</span></code> is a way to let the view know there was a data change.</p>
<div class="figure">
<img alt="../_images/cityui_populated.png" src="../_images/cityui_populated.png" />
</div>
</div>
</div>
<div class="section" id="summary">
<h2>18.6. Summary<a class="headerlink" href="#summary" title="Permalink to this headline">Â¶</a></h2>
<p>The plugin created is a very simple plugin but it can be re-used now and extended by other types for different applications. Using plugins creates a very flexible solution. For example, you can now start the UI by just using the <code class="docutils literal notranslate"><span class="pre">qmlscene</span></code>. Open the folder where your <code class="docutils literal notranslate"><span class="pre">CityUI</span></code> project is a start the UI with <code class="docutils literal notranslate"><span class="pre">qmlscene</span> <span class="pre">main.qml</span></code>. I really encourage you to write your applications in a way so that they work with a <code class="docutils literal notranslate"><span class="pre">qmlscene</span></code>. This has a tremendous increase in turnaround time for the UI developer and it is also a good habit to keep a clear separation.</p>
<p>Using plugins has one drawback the deployment gets more difficult for simple applications. You need now to deploy your plugin with your application. If this is a problem for you-you can still use the same <code class="docutils literal notranslate"><span class="pre">FileIO</span></code> object to register it directly in your <code class="docutils literal notranslate"><span class="pre">main.cpp</span></code> using <code class="docutils literal notranslate"><span class="pre">qmlRegisterType</span></code>. The QML code would stay the same.</p>
<p>Often in larger projects, you do not use an application as such. You have a simple qml runtime similar to <code class="docutils literal notranslate"><span class="pre">qmlscene</span></code> and require all native functionality to come as plugins. And your projects are simple pure qml projects using these qml extension plugins. This provides a great flexibility and removes the compilation step for UI changes. After editing a QML file you just need to run the UI. This allows the user interface writers to stay flexible and agile to make all these little changes to push pixels.</p>
<p>Plugins provide a nice and clean separation between C++ backend development and QML frontend development. When developing QML plugins always have the QML side in mind and do not hesitate to start with a QML only mockup first to validate your API before you implement it in C++. If an API is written in C++ people often hesitate to change it or not to speak of to rewrite it. Mocking an API in QML provides much more flexibility and less initial investment. When using plugins the switch between a mocked API and the real API is just changing the import path for the qml runtime.</p>
</div>
</div>


    </div>
      
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2012-2018 JÃ¼rgen Bocklage-Ryannel and Johan Thelin. This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.<br/>
      Last updated on Nov 10, 2020.<br/>
    </p>
  </div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46104829-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>